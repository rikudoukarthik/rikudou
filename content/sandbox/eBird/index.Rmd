---
title: "Birding stats"
date: "`r format(Sys.Date(), format = '%Y-%m-%d')`"
draft: false
subtitle: ""
output: blogdown::html_page
excerpt: An attempt to transfer my childhood obsession with sport statistics into the one sport I engage in nowadays.
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(glue)
library(reactable)
library(skimmr)

knitr::opts_chunk$set(echo = FALSE, include=FALSE, warnings = FALSE, messages = FALSE)

cur_dir <- "content/sandbox/eBird/"

# eBird data
csv_name <- "MyEBirdData.csv"
zip_file <- list.files(path = here("assets"), 
                       pattern = "ebird_[0-9]*.zip", 
                       full.names = FALSE)
unzip(zipfile = here("assets", zip_file), 
      files = csv_name, 
      overwrite = TRUE,
      exdir = here("assets"))
data_file <- here("assets", csv_name)
  
```

Birding to me is a lot of things; at times, I see it as a sport. Given my love for numbers and my obsession with cricket stats as a kid (more on this coming soon!), I wanted to try and implement a similar sort of analysis and visualisation of sport statistics.

**Disclaimer:** All this is based off my data uploaded to eBird. That covers most, but not all, of the birding I have done.

# Career in numbers {#numbers}

```{r}

rawdata <- skimmr::read.mydata(data_file, cols_style_ebd = TRUE) %>% 
  # removing unnecessary columns and renaming necessary ones
  dplyr::select(-c(SCIENTIFIC.NAME, EFFORT.AREA.HA)) 

# remove spuhs and slashes (mydata does not contain species category column)
nonspec <- rawdata %>% 
  filter(str_ends(COMMON.NAME, "sp.") |
           str_detect(COMMON.NAME, "/")) %>% 
  # ignoring slashes in true species
  filter(!(COMMON.NAME %in% c("Long-tailed Shrike (tricolor/longicaudatus)",
                              "Western Yellow Wagtail (flava/beema)",
                              "White Wagtail (White-faced/Transbaikalian)",
                              "Redpoll (Common/Lesser)"))) %>% 
  distinct(COMMON.NAME)

rawdata <- rawdata %>% anti_join(nonspec, by = "COMMON.NAME")

tot_lists <- n_distinct(rawdata$SAMPLING.EVENT.IDENTIFIER)

# 50s, 100s, average score
stats0 <- rawdata %>% 
  group_by(SAMPLING.EVENT.IDENTIFIER) %>% 
  dplyr::summarise(NO.SP = n_distinct(COMMON.NAME)) %>% 
  mutate(AVERAGE.SCORE = mean(NO.SP) %>% floor()) %>% 
  filter(NO.SP >= 50) %>% 
  mutate(`50s` = n_distinct(SAMPLING.EVENT.IDENTIFIER)) %>% 
  filter(NO.SP >= 100) %>% 
  dplyr::summarise(`50s` = min(`50s`),
                   `100s` = n_distinct(SAMPLING.EVENT.IDENTIFIER),
                   `Average score` = min(AVERAGE.SCORE)) %>% 
  pivot_longer(everything(), names_to = "STATISTIC", values_to = "VALUE") %>% 
  mutate(UNIT = c("-", "-", "spp."),
         CHECKLIST = "-",
         VALUE = glue("{VALUE}"))

# all-time high score
high_score <- rawdata %>% 
  group_by(SAMPLING.EVENT.IDENTIFIER, DURATION.MINUTES, STATE.CODE) %>% 
  dplyr::summarise(NO.SP = n_distinct(COMMON.NAME)) %>% 
  ungroup() %>% 
  filter(NO.SP == max(NO.SP)) %>% 
  transmute(STATISTIC = "Highest score",
            VALUE = glue("{NO.SP} ({DURATION.MINUTES}) in {STATE.CODE}"),
            UNIT = "spp. (min)",
            CHECKLIST = glue("https://ebird.org/checklist/{SAMPLING.EVENT.IDENTIFIER}"))

# high score in 1 hour
high_score_hour <- rawdata %>% 
  filter(DURATION.MINUTES <= 60) %>% 
  group_by(SAMPLING.EVENT.IDENTIFIER, DURATION.MINUTES, STATE.CODE) %>% 
  dplyr::summarise(NO.SP = n_distinct(COMMON.NAME)) %>% 
  ungroup() %>% 
  filter(NO.SP == max(NO.SP)) %>% 
  transmute(STATISTIC = "Highest score within 1 hour",
            VALUE = glue("{NO.SP} ({DURATION.MINUTES}) in {STATE.CODE}"),
            UNIT = "spp. (min)",
            CHECKLIST = glue("https://ebird.org/checklist/{SAMPLING.EVENT.IDENTIFIER}"))

# high and low speeds
stats_speed <- rawdata %>% 
  filter(ALL.SPECIES.REPORTED == 1,
         # removing lists without duration info
         !is.na(DURATION.MINUTES)) %>% 
  mutate(DURATION.MINUTES = as.integer(DURATION.MINUTES)) %>% 
  group_by(SAMPLING.EVENT.IDENTIFIER) %>% 
  dplyr::summarise(NO.SP = n_distinct(COMMON.NAME),
                   DURATION.MINUTES = min(DURATION.MINUTES)) %>% 
  mutate(SPEED = round((NO.SP/DURATION.MINUTES), 3), # species per hour
         HIGH.SPEED = max(SPEED),
         LOW.SPEED = min(SPEED)) %>% 
  filter(SPEED == HIGH.SPEED | SPEED == LOW.SPEED) %>% 
  # column saying high or low
  mutate(STATISTIC = if_else(SPEED == HIGH.SPEED, 
                             "Highest speed", 
                             "Lowest speed")) %>% 
  left_join(rawdata, by = c("SAMPLING.EVENT.IDENTIFIER", "DURATION.MINUTES")) %>% 
  distinct(SPEED, STATISTIC, STATE.CODE, SAMPLING.EVENT.IDENTIFIER) %>% 
  arrange(desc(SPEED)) %>% 
  group_by(SPEED, STATISTIC) %>% 
  reframe(CHECKLIST = glue("https://ebird.org/checklist/{SAMPLING.EVENT.IDENTIFIER}"),
          VALUE = glue("{SPEED} ({SPEED*60}) in {STATE.CODE}")) %>% 
  group_by(STATISTIC) %>% 
  dplyr::summarise(VALUE = str_flatten_comma(VALUE),
                   UNIT = "spp./min (spp./h)",
                   CHECKLIST = str_flatten_comma(CHECKLIST))

# combining all
stats_all <- stats0 %>% 
  bind_rows(high_score, high_score_hour, stats_speed)
  
# # to decide how wide cell should be
# wrap_width_value <- str_split(stats_all$VALUE, ", ") %>% 
#   map_dbl(~ str_length(.) %>% max()) %>% 
#   max()
# wrap_width_checklist <- str_split(stats_all$CHECKLIST, ", ") %>% 
#   map_dbl(~ str_length(.) %>% max()) %>% 
#   max()

```

My birding stats, as analysed from `r tot_lists` checklists. This only includes non--zero-species checklists, and this directly impacts metrics such as lowest speed.

```{r stats-table, include=TRUE}

# tables of stats
# stats_all %>% 
#   mutate(across(everything(), ~ as.character(.))) %>% 
#   gt() %>%
#   tab_style(
#     style = cell_text(weight = "bold"),
#     locations = cells_body(columns = 1)
#   ) %>%
#    tab_style(
#     style = cell_text(align = "left"),
#     locations = cells_column_labels(everything())
#   ) %>% 
#   cols_width(
#     1 ~ px(144),  # 9em ~ 144px
#     2 ~ px(192),  # 12em ~ 192px
#     4 ~ px(304)   # 19em ~ 304px
#   ) %>%
#   text_transform(locations = cells_body(c("CHECKLIST")),
#                  fn = function(x) {
#                    map_chr(x, ~ as.character(html(
#                      
#                      if (.x == "-") .x else paste0( # only hyperlink if list exists
#                        '<a href="', .x, '" target="_blank">', 
#                        str_remove_all(.x, "https://ebird.org/checklist/"), 
#                        '</a>'
#                      )
#                      
#                    )))
#                  }) %>% 
#   opt_row_striping(row_striping = TRUE)


stats_all %>%
  mutate(across(everything(), as.character)) %>%
  reactable(
    columns = list(
      CHECKLIST = colDef(
        html = TRUE,
        # Create clickable link with the URL as link text
        cell = function(value) {
          if (value == "-") value else
          htmltools::tags$a(href = value, target = "_blank", 
                            str_remove_all(value, "https://ebird.org/checklist/")) %>% 
            as.character()
        }
      )
    ),
    searchable = FALSE,
    striped = TRUE,
    highlight = TRUE,
    theme = NULL,
    rowStyle = function(index) {
    if (index %% 2 == 0) {
      list(background = "transparent")   # even rows transparent
    } else {
      list(background = "grey70")       # odd rows inherit page bg
    }
  }
  )

```

# Career mapped {#map}

Spatial visualisation of my eBirding in the style of an eBird profile, but as a bigger sandbox... **Coming soon!**
